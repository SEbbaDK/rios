Program
	= Decs
Decs
	= (Dec _)*
Dec
	= NameDec
    / StateDec
    / ReactDec
    / StructDec
ReactDec
	= ("onenter"/"always") _ Result
    / "when" _ Expr _ WhenCont
    / ("every"/"after") _ Expr _ Unit _ Result
WhenCont
	= (CompOp/BoolOp)? _ Cases
    / Result
Cases
	= Case _ (Cases)*
Case
	= "|" _ BoolOp? _ Expr _ Result
Result
	= ":" _ Stmts
Unit
	= "d"/"h"/"m"/"s"/"ms"/"µs"

NameDec
	= Type _ NameId _ Params? _ "=" _ (Stmts/Expr)
NameId
	= [a-z][a-zA-Z]*
Params
    = "(" _ (Param _ ("," _ Param)*)? _ ")"
Param
    = Type _ NameId
Type
    = "bool"/"int"/"float"/"short"/"pin"/"serial"/"proc"

StateDec
	= "default"? _ "state" _ StateId _ "{" _ Decs _ "}"
StateId
	= [A-Z][a-zA-Z]*

StructDec
	= "struct" _ NameId _ "{" _ (NameDec _)* _ "}"

Stmts
	= "[" _ Stmt _ (";" _ Stmt?)* _ "]"
    / Stmt
Stmt
	= NameDec
    / NameId _ ((AritOp/BitOp)?"=") _ Expr
    / "enter" _ StateId
    / "run" _ Expr

Expr
	= ExprBOr //Con (_ (AritOp/BoolOp/CompOp) _ Expr)?
ExprBOr
	= ExprBAnd (_ BoolOrOp _ Expr)?
ExprBAnd
	= ExprBXor (_ BoolAndOp _ Expr)?
ExprBXor
	= ExprComp (_ BoolXorOp _ Expr)?
ExprComp
	= ExprMult (_ (CompOp/ChangeOp) _ Expr)?
ExprMult
	= ExprAdd (_ (AritMultOp/BitAndOp/BitXorOp) _ Expr)?
ExprAdd
	= ExprNeg (_ (AritAddOp/BitOrOp) _ Expr)?
ExprNeg
	= (BoolNegOp/BitNegOp)? _ ExprOld
ExprOld
    = (OldOp)? _ ExprSub
ExprSub
	= ExprCall (_ "." _ Expr)?
ExprCall
	= ExprParen _ ("(" _ (Expr _ ("," _ Expr)*)? _ ")")?
ExprParen
    = "(" _ Expr _ ")"
    / Con

AritOp
	= AritAddOp/AritMultOp
AritAddOp
	= [+-]
AritMultOp
	= [*%/]
BitOp
	= BitNegOp/BitAndOp/BitOrOp/BitXorOp/BitShiftOp
BitNegOp
	= "~"
BitAndOp
	= [&] ![&]
BitOrOp
	= [|] ![|]
BitXorOp
	= "^" !"^"
BitShiftOp
	= ">>"/"<<"
BoolOp
	= BoolOrOp/BoolAndOp/BoolXorOp/BoolNegOp
BoolOrOp
	= "||"
BoolAndOp
	= "&&"
BoolXorOp
    = "^^"
BoolNegOp
	= "!"
CompOp
	= [=<>!][=]
ChangeOp
	= "->"/"!>"
OldOp
	= "§"
Con
    = "B"[01]+
    / ("H"/"0"?"x")[0-9a-fA-F]+
	/ "D"?[0-9]+("."[0-9]+)?
    / "true" / "false" / "high" / "low"
    / ("o""utput"? / "i""nput"? ("-"? "p" "ullup"?)?) _ "@" _ "A"?[0-9]+
    / ("usb"/"pin") _ "$" _ [0-9]+
    / NameId

_
	= $[ \t\n\r]*
